<!DOCTYPE html>
<html lang="es">
{% load static %}

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Reservaciones A&N{% endblock %}</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="//unpkg.com/alpinejs" defer></script>

</head>

<body class="bg-gray-50 text-gray-900 {% block body_class %}{% endblock %}">

  {% block navbar %}
  <!-- ========== NAVBAR NUEVO ========== -->
  <div class="bg-white">
    <header class="relative bg-white">
      <p
        class="flex h-10 items-center justify-center bg-indigo-600 px-4 text-sm font-medium text-white sm:px-6 lg:px-8">
        Primer reserva con 10% de descuento ‚Äî c√≥digo PONGAME10
      </p>


      <!-- ========== NAVBAR AJUSTADO ========== -->
      <nav class="bg-white border-b border-gray-200 relative z-50 overflow-visible">
        <div class="relative flex items-center h-16 px-4 sm:px-6 lg:px-8 w-full max-w-full mx-auto">

          <!-- IZQUIERDA: Logo + Enlaces -->
          <div class="flex items-center space-x-6">
            <a href="{% url 'inicio' %}">
              <img src="https://tailwindcss.com/plus-assets/img/logos/mark.svg?color=indigo&shade=600" alt="Logo"
                class="h-12 w-auto" />
            </a>

            <a href="{% url 'lista_salones' %}?default_categoria=reuniones"
              class="text-gray-800 text-base font-medium hover:text-gray-900">Reuniones</a>

            <a href="{% url 'lista_salones' %}?default_categoria=expos"
              class="text-gray-800 text-base font-medium hover:text-gray-900">Expos</a>

            <a href="{% url 'lista_salones' %}?default_categoria=fiestas"
              class="text-gray-800 text-base font-medium hover:text-gray-900">Fiestas</a>

          </div>

          <!-- üî• SEARCHBAR FUNCIONAL CON DROPDOWN -->
          <div x-data="searchComponent()" class="absolute left-1/2 -translate-x-1/2 w-full max-w-md">

            <input type="text" placeholder="Buscar..." x-model="query" @input="performSearch" class="w-full border border-gray-300 rounded-full px-4 py-2
                     focus:outline-none focus:ring-2 focus:ring-indigo-500" />

            <!-- Dropdown de resultados -->
            <div x-show="open && (results.length > 0 || noResults)" @click.away="open = false" x-transition
              class="absolute mt-2 w-full bg-white border border-gray-200 rounded-xl shadow-lg z-50">

              <!-- No Results -->
              <div x-show="noResults" class="px-4 py-2 text-gray-500 text-sm">
                No se encontraron resultados.
              </div>


              <!-- Results -->
              <template x-for="(item, index) in results" :key="item.id">

                <div>

                  <!-- RESULT ITEM -->
                  <a :href="`/salon/${item.id}/`"
                    class="flex items-center justify-between px-4 py-3 hover:bg-gray-100 cursor-pointer">

                    <!-- LEFT SIDE -->
                    <div class="flex flex-col">

                      <!-- NAME + PRICE ON SAME LINE -->
                      <div class="flex items-center space-x-2">
                        <span class="font-medium text-gray-800" x-text="item.nombre"></span>

                        <span class="text-sm text-gray-600">
                          $<span x-text="item.formattedPrice"></span>
                        </span>
                      </div>

                      <!-- CATEGORY + CITY -->
                      <div class="flex items-center space-x-2 mt-1">
                        <span x-html="item.icon"></span>
                        <span x-html="item.categoryLabel"></span>
                        <span x-html="item.cityLabel"></span>
                      </div>

                    </div>

                    <!-- RIGHT: WIDE + SHORT IMAGE -->
                    <img :src="item.imagen" class="w-32 h-16 object-cover rounded-xl border border-gray-200 ml-4"
                      alt="Room image" />

                  </a>

                  <!-- SEPARATOR -->
                  <div x-show="index < results.length - 1" class="flow-root border-b border-gray-200 my-2"></div>

                </div>

              </template>





            </div>

          </div>

          <!-- CONTENEDOR DERECHO FIJO -->
          <div class="flex items-center ml-auto space-x-6">

            {% if not request.user.is_authenticated %}
            <!-- LOGIN / REGISTER -->
            <div class="flex items-center space-x-2">
              <a href="{% url 'login' %}" class="text-gray-800 text-base font-medium hover:text-gray-900 p-2">
                Iniciar sesi√≥n
              </a>
              <span class="h-6 w-px bg-gray-300"></span>
              <a href="{% url 'registro' %}" class="text-gray-800 text-base font-medium hover:text-gray-900 p-2">
                Crear cuenta
              </a>
            </div>
            {% else %}
            <!-- ICONOS USUARIO / RESERVACIONES -->
            <div x-data="{ open: false }" class="relative">
              <button @click="open = !open" class="text-gray-800 hover:text-gray-900 p-2 flex items-center">
                <svg class="w-7 h-7 text-gray-800" fill="none" viewBox="0 0 24 24">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Zm0 0a8.949 8.949 0 0 0 4.951-1.488A3.987 3.987 0 0 0 13 16h-2a3.987 3.987 0 0 0-3.951 3.512A8.948 8.948 0 0 0 12 21Zm3-11a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
              </button>

              <div x-cloak x-show="open" x-transition @click.away="open = false"
                class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-50">
                <a href="{% url 'mi_perfil' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Mi cuenta</a>
                <a href="{% url 'mis_favoritos' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Mis
                  favoritos</a>
                <a href="{% url 'help' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Ayuda</a>
                {% if user.is_staff %}
                <a href="/admin/" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Modo Admin</a>
                {% endif %}
                <form method="post" action="{% url 'logout' %}">
                  {% csrf_token %}
                  <button type="submit" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-100">Cerrar
                    sesi√≥n</button>
                </form>
              </div>

            </div>

            <div x-data="{ open: false }" class="relative">
              <button @click="open = !open"
                class="text-gray-800 hover:text-gray-900 p-2 flex items-center space-x-1 relative">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    d="M4 10h16M8 14h8m-4-7V4M7 7V4m10 3V4M5 20h14a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1Z" />
                </svg>
                <span class="text-gray-800 font-medium">{{ proximas_reservaciones|length }}</span>
              </button>

              <div x-cloak x-show="open" x-transition @click.away="open = false"
                class="absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-lg py-3 z-50">
                <div class="px-4 pb-2">
                  <p class="text-sm font-semibold text-gray-600">Tus reservaciones pr√≥ximas</p>
                  <div class="border-t border-gray-200 mt-2"></div>
                </div>

                {% if proximas_reservaciones|length == 0 %}
                <p class="px-4 py-3 text-gray-500 text-sm">No tienes reservaciones pr√≥ximas.</p>
                {% else %}
                {% for r in proximas_reservaciones|dictsort:"fecha_reserva"|slice:":3" %}
                <a href="{% url 'mis_reservaciones' %}" class="block px-4 py-2 hover:bg-gray-100 flow-root">
                  <div class="flex flex-col">
                    <span class="font-medium text-gray-800">{{ r.salon.nombre }}</span>
                    <span class="text-sm text-gray-500">{{ r.fecha_reserva }}</span>
                  </div>
                </a>
                {% endfor %}

                {% if proximas_reservaciones|length > 3 %}
                <a href="{% url 'mis_reservaciones' %}"
                  class="block text-center px-4 py-2 mt-2 text-indigo-600 font-medium hover:bg-indigo-50">Ver m√°s</a>
                {% endif %}
                {% endif %}
              </div>
            </div>

            {% endif %}

          </div> <!-- FIN CONTENEDOR DERECHO FIJO -->

        </div>
      </nav>
      {% endblock %}

    </header>
  </div>

  <!-- ========== BLOQUE DE CONTENIDO ========== -->
  <main class="pt-0">
    {% block content %}{% endblock %}
  </main>

  <!-- AlpineJS (ya cargado arriba) -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>


  <!-- üîç SEARCHBAR LOGIC -->
  <!-- üîç SEARCHBAR LOGIC -->
  <script>
    function searchComponent() {
      return {
        query: "",
        results: [],
        noResults: false,
        open: false,

        // ICONS
        categoryIcons: {
          fiestas: `
          <svg class="w-5 h-5 text-gray-500 xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
  <path fill="currentColor" fill-rule="evenodd" d="M17.6647 3.69423c-.0811-.25251-.2591-.46247-.495-.58368-.2359-.12121-.5103-.14375-.7628-.06265l-5.7127 1.83462c-.1263.04057-.2389.10389-.3349.18397C10.2478 5.02354 10.1266 5 10 5H4c-.55228 0-1 .44772-1 1v6c0 1.8638 1.27477 3.4299 3 3.874V19H5c-.55228 0-1 .4477-1 1s.44772 1 1 1h4c.55228 0 1-.4477 1-1s-.44772-1-1-1H8v-3.126c1.72523-.4441 3-2.0102 3-3.874V9.10505l.8825 2.74795c.5699 1.7746 2.2625 2.8759 4.0409 2.7712l.9558 2.9763-.9521.3057c-.5258.1689-.8152.7321-.6463 1.2579.1689.5258.732.8152 1.2579.6463l3.8084-1.2231c.5258-.1688.8152-.732.6463-1.2578-.1688-.5259-.732-.8152-1.2578-.6464l-.9522.3058-.9558-2.9763c1.5068-.9503 2.2417-2.8312 1.6718-4.60574l-1.8347-5.71263ZM9 7v1H5V7h4Zm7.0663-1.74212.3058.9521-3.8085 1.22309-.3057-.95211 3.8084-1.22308Z" clip-rule="evenodd"/>
</svg>

        `,
          reuniones: `
  <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
    <path fill="currentColor" fill-rule="evenodd" d="M12 6a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Zm-1.5 8a4 4 0 0 0-4 4 2 2 0 0 0 2 2h7a2 2 0 0 0 2-2 4 4 0 0 0-4-4h-3Zm6.82-3.096a5.51 5.51 0 0 0-2.797-6.293 3.5 3.5 0 1 1 2.796 6.292ZM19.5 18h.5a2 2 0 0 0 2-2 4 4 0 0 0-4-4h-1.1a5.503 5.503 0 0 1-.471.762A5.998 5.998 0 0 1 19.5 18ZM4 7.5a3.5 3.5 0 0 1 5.477-2.889 5.5 5.5 0 0 0-2.796 6.293A3.501 3.501 0 0 1 4 7.5ZM7.1 12H6a4 4 0 0 0-4 4 2 2 0 0 0 2 2h.5a5.998 5.998 0 0 1 3.071-5.238A5.505 5.505 0 0 1 7.1 12Z" clip-rule="evenodd"/>
  </svg>
`,

          expos: `
  <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
    <path fill-rule="evenodd" d="M7.05 4.05A7 7 0 0 1 19 9c0 2.407-1.197 3.874-2.186 5.084l-.04.048C15.77 15.362 15 16.34 15 18a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1c0-1.612-.77-2.613-1.78-3.875l-.045-.056C6.193 12.842 5 11.352 5 9a7 7 0 0 1 2.05-4.95ZM9 21a1 1 0 0 1 1-1h4a1 1 0 1 1 0 2h-4a1 1 0 0 1-1-1Zm1.586-13.414A2 2 0 0 1 12 7a1 1 0 1 0 0-2 4 4 0 0 0-4 4 1 1 0 0 0 2 0 2 2 0 0 1 .586-1.414Z" clip-rule="evenodd"/>
  </svg>
`,

        },

        async performSearch() {
          this.open = true;

          if (this.query.length < 2) {
            this.results = [];
            this.noResults = false;
            return;
          }

          try {
            const res = await fetch(`/api/search/?q=${encodeURIComponent(this.query)}`);
            const data = await res.json();

            this.results = data.slice(0, 5).map(item => {
              return {
                ...item,

                // Icon
                icon: this.categoryIcons[item.categoria.toLowerCase()] || "",

                // Italic labels
                categoryLabel: `<span class="italic text-gray-500 ml-1">${item.categoria}</span>`,
                cityLabel: `<span class="italic text-gray-400 ml-1">${item.ciudad}</span>`,

                // Formatted price
                formattedPrice: Number(item.precio).toLocaleString("en-US", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                }),

                // Image (YOUR FIELD NAME)
                imagen: item.imagen || "{% static 'myapp/default.jpg' %}"
              };
            });

            this.noResults = this.results.length === 0;

          } catch (err) {
            console.error("Search error:", err);
          }
        }
      };
    }
  </script>




  {% block footer %}
  {% include "theme/footer.html" %}
  {% endblock %}

</body>

</html>