{% extends 'theme/base.html' %}
{% load humanize %}

{% load custom_filters %}


{% block title %}Mi Perfil{% endblock %}

{% block content %}
<div class="w-full min-h-screen bg-gray-100 py-10">

  <div class="max-w-8xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- ===================== TARJETA DE PERFIL (IZQUIERDA) ===================== -->
    <div class="bg-white rounded-2xl shadow p-6 relative overflow-visible self-start sticky top-10">

      <!-- BADGE ADMIN -->
      {% if usuario.is_staff or usuario.is_superuser %}
      <span
        class="absolute top-4 left-4 rounded-full bg-purple-100 px-2.5 py-0.5 text-sm whitespace-nowrap text-purple-700">
        Admin
      </span>
      {% endif %}

      <!-- Botón Editar -->
      <button onclick="document.getElementById('modalEditarPerfil').classList.remove('hidden')"
        class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
        </svg>
      </button>

      <!-- Foto circular (imagen por defecto si no hay avatar) -->
      <div
        class="w-32 h-32 rounded-full bg-gray-200 overflow-hidden mx-auto mt-2 shadow-sm flex items-center justify-center">

        {% if usuario.profile.avatar %}
        <img src="{{ usuario.profile.avatar.url }}" class="object-cover w-full h-full">
        {% else %}
        <img src="/media/avatars/img_default.png" class="object-cover w-full h-full">
        {% endif %}

      </div>


      <!-- Nombre y username -->
      <h2 class="text-xl font-bold mt-4 text-center">{{ usuario.profile.full_name }}</h2>
      <p class="text-gray-600 text-sm text-center">@{{ usuario.username }}</p>

      <!-- ================= DATOS DEL PERFIL ================= -->
      <div class="w-full mt-8 space-y-5">

        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Correo electrónico</p>
          <p class="font-semibold text-gray-800 break-all">{{ usuario.email }}</p>
        </div>

        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Teléfono</p>
          <p class="font-semibold text-gray-800">{{ usuario.profile.phone|default:"No registrado" }}</p>
        </div>

        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Fecha de nacimiento</p>
          <p class="font-semibold text-gray-800">
            {{ usuario.profile.birth_date|date:"d/m/Y"|default:"No registrada" }}
          </p>
        </div>

        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Género</p>
          <p class="font-semibold text-gray-800">{{ usuario.profile.gender|default:"No especificado" }}</p>
        </div>

        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Dirección</p>
          <p class="font-semibold text-gray-800">{{ usuario.profile.address|default:"No registrada" }}</p>
        </div>

      </div>
    </div>




    <!-- ===================== DERECHA COMPLETA ===================== -->
    <div class="lg:col-span-2 space-y-6">

      <!-- === FILA SUPERIOR: STATS + DASHBOARD === -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- ===================== STATS (IZQUIERDA) ===================== -->
<div class="bg-white rounded-2xl shadow p-6">
  <h2 class="text-xl font-bold mb-4">Gastos</h2>

  <div class="grid grid-cols-1 md:grid-cols-1 gap-4">

    <!-- Stat 1: Gasto en Salones -->
    {% with stat=stats.gasto_salon %}
    <article class="rounded-lg border border-gray-100 bg-white p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Gasto en Salones</p>
          <p class="text-2xl font-medium text-gray-900">${{ stat.total|floatformat:2|intcomma }}</p>
        </div>

        <span class="rounded-full bg-blue-100 p-3 text-blue-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="size-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </span>
      </div>

      <!-- Flecha de porcentaje -->
      <div class="mt-1 flex gap-1 {% if stat.porcentaje >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
        {% if stat.porcentaje >= 0 %}
        <svg xmlns="http://www.w3.org/2000/svg" class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
        </svg>
        {% else %}
        <svg xmlns="http://www.w3.org/2000/svg" class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
        </svg>
        {% endif %}

        <p class="flex gap-2 text-xs">
          <span class="font-medium">{{ stat.porcentaje }}%</span>
          <span class="text-gray-500">Desde el mes pasado</span>
        </p>
      </div>
    </article>
    {% endwith %}

    <!-- Stat 2: Gasto en Servicios Extra -->
    {% with stat=stats.gasto_servicios %}
    <article class="rounded-lg border border-gray-100 bg-white p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Gasto en Servicios Extra</p>
          <p class="text-2xl font-medium text-gray-900">${{ stat.total|floatformat:2|intcomma }}</p>
        </div>

        <span class="rounded-full bg-blue-100 p-3 text-blue-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="size-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </span>
      </div>

      <!-- Flecha de porcentaje -->
      <div class="mt-1 flex gap-1 {% if stat.porcentaje >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
        {% if stat.porcentaje >= 0 %}
        <svg xmlns="http://www.w3.org/2000/svg" class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
        </svg>
        {% else %}
        <svg xmlns="http://www.w3.org/2000/svg" class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
        </svg>
        {% endif %}

        <p class="flex gap-2 text-xs">
          <span class="font-medium">{{ stat.porcentaje }}%</span>
          <span class="text-gray-500">Desde el mes pasado</span>
        </p>
      </div>
    </article>
    {% endwith %}

  </div>
</div>



        <!-- ===================== CHART (DERECHA) ===================== -->
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-xl font-bold mb-4">Actividad de Reservaciones</h2>

          <div class="h-64 bg-gray-100 rounded-lg flex items-center justify-center text-gray-500">
            <canvas id="chartActividad"></canvas>
          </div>
        </div>

      </div>

      <!-- ===================== TODAS LAS RESERVACIONES (ABAJO) ===================== -->
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Todas tus reservaciones</h2>

        {% if reservaciones %}
        <!-- Cabecera de columnas -->
        <div class="grid grid-cols-[3fr_2.6fr_5.8fr] gap-4 font-semibold text-gray-700 border-b pb-2 mb-2">
          <div>Salón</div>
          <div>Fecha</div>
          <div>Status</div>
        </div>

        <!-- Lista de reservaciones -->
        <ul class="space-y-2">
          {% for r in reservaciones %}
          <li class="grid grid-cols-4 gap-4 items-center p-3 border rounded-lg shadow-sm bg-white">

            <!-- Columna 1: Nombre del salón -->
            <div>{{ r.salon.nombre }}</div>

            <!-- Columna 2: Fecha -->
            <div>{{ r.fecha_reserva|date:"d/m/Y" }}</div>

            <!-- Columna 3: Status -->
            <div>
              {% if r.estado == "cancelada" %}
              <span class="px-2 py-0.5 rounded-full bg-red-100 text-red-700 text-sm">
                Cancelada
              </span>
              {% elif r.activa %}
              <span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-sm">
                Próxima
              </span>
              {% elif r.tiempo == "pasada" %}
              <span class="px-2 py-0.5 rounded-full bg-gray-200 text-gray-700 text-sm">
                Pasada
              </span>
              {% endif %}
            </div>

            <!-- Columna 4: Link -->
            <div>
              <a href="{% url 'inicio' %}" class="text-blue-600 hover:underline text-sm">
                Ver reservación
              </a>
            </div>

          </li>
          {% empty %}
          <p class="text-gray-500 text-sm">No tienes reservaciones aún.</p>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-600">Aún no tienes reservaciones.</p>
        {% endif %}
      </div>



    </div>

  </div>
</div>



<!-- MODAL EDITAR PERFIL -->
<div id="modalEditarPerfil"
  class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden flex items-center justify-center z-50">
  <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl p-6 relative">

    <!-- Cerrar -->
    <button onclick="document.getElementById('modalEditarPerfil').classList.add('hidden')"
      class="absolute top-3 right-3 text-gray-500 hover:text-black">
      ✕
    </button>

    <h2 class="text-xl font-bold mb-4">Editar información de perfil</h2>

    <form action="{% url 'editar_perfil' %}" method="POST" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <div>
          <label class="text-gray-600 text-sm">Nombre completo</label>
          <input type="text" name="full_name" value="{{ usuario.profile.full_name }}"
            class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring focus:ring-blue-200">
        </div>

        <div>
          <label class="text-gray-600 text-sm">Username</label>
          <input type="text" name="username" value="{{ usuario.username }}"
            class="w-full mt-1 px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
        </div>

        <div>
          <label class="text-gray-600 text-sm">Fecha de nacimiento</label>
          <input type="date" name="birth_date" value="{{ usuario.profile.birth_date }}"
            class="w-full mt-1 px-3 py-2 border rounded-lg">
        </div>

        <div>
          <label class="text-gray-600 text-sm">Género</label>
          <select name="genero" class="w-full mt-1 px-3 py-2 border rounded-lg">
            <option value="Masculino" {% if usuario.profile.gender|default_if_none:"" == "Masculino" %}selected{% endif %}>Masculino</option>
<option value="Femenino" {% if usuario.profile.gender|default_if_none:"" == "Femenino" %}selected{% endif %}>Femenino</option>
<option value="Otro" {% if usuario.profile.gender|default_if_none:"" == "Otro" %}selected{% endif %}>Otro</option>


          </select>
        </div>

        <div>
          <label class="text-gray-600 text-sm">Correo electrónico</label>
          <input type="email" name="email" value="{{ usuario.email }}"
            class="w-full mt-1 px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
        </div>

        <div class="md:col-span-2">
          <label class="text-gray-600 text-sm">Teléfono</label>
          <input type="text" name="phone" value="{{ usuario.profile.phone }}"
            class="w-full mt-1 px-3 py-2 border rounded-lg">
        </div>

        <div class="md:col-span-2">
          <label class="text-gray-600 text-sm">Dirección</label>
          <input type="text" name="address" value="{{ usuario.profile.address }}"
            class="w-full mt-1 px-3 py-2 border rounded-lg">
        </div>

        <div class="md:col-span-2">
          <label class="text-gray-600 text-sm">Foto de perfil</label>
          <input type="file" name="foto" class="w-full mt-1">
        </div>

      </div>

      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700 transition">
        Guardar cambios
      </button>

    </form>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const parsedActividad = JSON.parse('{{ actividad_json|escapejs }}');
const labelsActividad = parsedActividad.map(a => a.dia);
const dataActividad = parsedActividad.map(a => a.total);

const ctx = document.getElementById('chartActividad').getContext('2d');

// Creamos los labels en rangos de 5 días
const maxDia = Math.max(...labelsActividad);
const xLabels = [];
for (let i = 1; i <= maxDia; i += 5) {
    const end = Math.min(i + 4, maxDia);
    xLabels.push(`${i}-${end}`);
}

// Creamos los datos agrupando cada 5 días
const groupedData = [];
for (let i = 0; i < dataActividad.length; i += 5) {
    const slice = dataActividad.slice(i, i + 5);
    const total = slice.reduce((a, b) => a + b, 0);
    groupedData.push(total);
}

new Chart(ctx, {
    type: 'line',
    data: {
        labels: xLabels,
        datasets: [{
            label: 'Ingresos del mes',
            data: groupedData,
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.2)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

</script>




{% endblock %}