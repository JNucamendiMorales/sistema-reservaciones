{% extends "admin_custom/base_admin.html" %}
{% load static %}

{% block title %}Gr√°ficos de Salones{% endblock %}
{% block header %}Gr√°ficos de Salones{% endblock %}

{% block content %}
<div class="flex flex-wrap gap-8 items-start overflow-hidden">

  <!-- === GRID PRINCIPAL === -->
  <div class="flex flex-wrap gap-6">

    <!-- 1Ô∏è TOP 5 CALIFICACI√ìN (Barras verticales) -->
    <div
      class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-lg h-[260px] w-[590px]">
      <h5 class="text-gray-400 text-sm mb-4">Salones con mejores rese√±as</h5>
      <div class="h-[190px] w-full">
        <canvas id="salonesRatingChart" style="width:100%;height:220px;"></canvas>
      </div>
    </div>

    <!-- 2Ô∏è TOP 5 PRECIOS (Barras horizontales) -->
    <div
      class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-lg h-[260px] w-[650px]">
      <h5 class="text-gray-400 text-sm mb-4">Salones mas caros</h5>
      <div class="h-[190px] w-full">
        <canvas id="salonesPriceChart" style="width:100%;height:220px;"></canvas>
      </div>
    </div>

  </div>

  <!-- Tarjeta + botones (line chart + controles) -->
  <div class="flex flex-nowrap gap-8 items-start">

    <!-- 3Ô∏è‚É£ TOP 5 INGRESOS (L√≠neas) -->
    <div
      class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-lg h-[340px] w-[900px] flex">

      <div class="h-[260px] w-full">
        <h5 class="text-gray-400 text-sm mb-3">Salones con m√°s Ingresos</h5>
        <canvas id="salonesIncomeChart" class="h-full w-[300px]"></canvas>
      </div>
      

    </div>

    <!-- === BOTONES DE FILTRO === -->
    <div class="flex flex-col justify-start space-y-8 mt-4">

      <!-- Grupo: Periodo -->
      <div class="flex flex-col items-start space-y-2">
        <span class="text-gray-300 font-medium text-lg">Periodo</span>
        <div class="flex space-x-3">
          <button id="btnSemana"
            class="filtro-periodo px-4 py-2 rounded-lg text-white font-semibold text-sm transition bg-indigo-600">üóìÔ∏è
            Semanal</button>
          <button id="btnMes"
            class="filtro-periodo px-4 py-2 rounded-lg text-gray-200 font-semibold text-sm bg-gray-700 hover:bg-gray-600 transition">üìÖ
            Mensual</button>
        </div>
      </div>

      <!-- Grupo: Descargar -->
      <div class="flex flex-col items-start space-y-2">
        <span class="text-gray-300 font-medium text-lg">Descargar</span>
        <div class="flex space-x-3">
          <button id="btnXLSX"
            class="px-4 py-2 bg-blue-600 rounded-lg text-white font-semibold text-sm hover:bg-blue-500 transition">üìä
            XLSX</button>
          <button id="btnCSV"
            class="px-4 py-2 bg-blue-600 rounded-lg text-white font-semibold text-sm hover:bg-blue-500 transition">üóÉÔ∏è
            CSV</button>
          <button id="btnPDF"
            class="px-4 py-2 bg-blue-600 rounded-lg text-white font-semibold text-sm hover:bg-blue-500 transition">üìÑ
            PDF</button>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
  html,
  body {
    overflow: hidden !important;
    height: 100%;
  }

  * {
    box-sizing: border-box;
    max-width: 100vw;
  }

  body {
    margin: 0;
    padding: 0;
  }

  canvas {
    display: block;
    max-width: 100%;
    height: auto;
  }

  /*Para ver la toda estructura en rojo

  * { outline: 1px solid red; }
  
  */
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let periodo = "semana";

  let ratingChart = null;
  let priceChart = null;
  let incomeChart = null;

  const COLORS = [
    "#4F46E5", "#22C55E", "#EAB308", "#F97316", "#EF4444",
    "#14B8A6", "#A855F7", "#3B82F6", "#06B6D4", "#F43F5E"
  ];

  function fetchJson(url) {
    return fetch(url).then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
      return r.json();
    });
  }

  function activarBoton(grupo, activoId) {
    document.querySelectorAll(`.${grupo}`).forEach(btn => {
      if (btn.id === activoId) {
        btn.classList.add("bg-indigo-600", "text-white");
        btn.classList.remove("bg-gray-700", "text-gray-200");
      } else {
        btn.classList.remove("bg-indigo-600", "text-white");
        btn.classList.add("bg-gray-700", "text-gray-200");
      }
    });
  }

  async function cargarSalonesCharts() {
    const q = `?periodo=${encodeURIComponent(periodo)}`;

    try {
      const datos = await fetchJson(`/api/datos_salones/${q}`);
      
      // Gr√°fica 1: Calificaci√≥n
      renderRatingChart(datos.top_calificacion);
      
      // Gr√°fica 2: Precios
      renderPriceChart(datos.top_precios);
      
      // Gr√°fica 3: Ingresos (barras con salones y periodos)
      renderIncomeChart(datos.top_ingresos);
    } catch (err) {
      console.error("Error cargando datos salones:", err);
      renderRatingChart([]);
      renderPriceChart([]);
      renderIncomeChart([]);
    }
  }

  function renderRatingChart(data) {
    // data es array: [{nombre, calificacion}, ...]
    let items = Array.isArray(data) ? data.slice(0, 5) : [];
    while(items.length<5) items.push({nombre:"-", calificacion:0});

    const labels = items.map(s=>s.nombre);
    const values = items.map(s=>parseFloat(s.calificacion||0));

    const ctx = document.getElementById("salonesRatingChart").getContext("2d");
    if(ratingChart) ratingChart.destroy();
    ratingChart = new Chart(ctx,{
      type:"bar",
      data:{labels, datasets:[{label:"Calificaci√≥n", data:values, backgroundColor:COLORS.slice(0,labels.length)}]},
      options:{
        indexAxis:'y',
        responsive:true, maintainAspectRatio:false,
        plugins:{legend:{display:false}, tooltip:{callbacks:{label:ctx=>` ${ctx.raw.toFixed(1)} ‚≠ê`}}},
        scales:{x:{beginAtZero:true, max:5, ticks:{color:"#ccc", stepSize:0.5}}, y:{ticks:{color:"#ccc"}}}
      }
    });
  }

  function renderPriceChart(data){
    // data es array: [{nombre, precio}, ...]
    let items = Array.isArray(data) ? data.slice(0, 5) : [];
    while(items.length<5) items.push({nombre:"-", precio:0});

    const labels = items.map(s=>s.nombre);
    const values = items.map(s=>parseFloat(s.precio||0));

    const ctx = document.getElementById("salonesPriceChart").getContext("2d");
    if(priceChart) priceChart.destroy();
    priceChart = new Chart(ctx,{
      type:"bar",
      data:{labels, datasets:[{label:"Precio (MXN)", data:values, backgroundColor:COLORS.slice(0,labels.length)}]},
      options:{
        indexAxis:'y',
        responsive:true, maintainAspectRatio:false,
        plugins:{legend:{display:false}, tooltip:{callbacks:{label:ctx=>` $ ${Number(ctx.raw).toLocaleString()}`}}},
        scales:{x:{ticks:{color:"#ccc", callback:v=>v?Number(v).toLocaleString():v}}, y:{ticks:{color:"#ccc"}}}
      }
    });
  }

  function renderIncomeChart(payload){
    // payload es array: [{salon, labels, data}, ...]
    const defaultSemana = ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];
    const defaultMes = ["1-5","6-10","11-15","16-20","21-25","26-31"];
    
    let series = [];
    let labels = periodo==="semana"?defaultSemana:defaultMes;

    if(!payload || !Array.isArray(payload)) {
      // Sin datos: llenar con salones vac√≠os
      for(let i=0;i<5;i++) series.push({salon:'-', data:labels.map(()=>0)});
    } else {
      // Usar datos reales
      series = payload.slice(0, 5).map(s=>({
        salon: s.salon || '-',
        labels: s.labels || labels,
        data: s.data || labels.map(()=>0)
      }));
      labels = series[0]?.labels || labels;
    }

    if(series.length<5) { 
      for(let i=series.length;i<5;i++) series.push({salon:'-', data:labels.map(()=>0)}); 
    }

    const datasets = series.map((s,idx)=>{
      const total = s.data.reduce((a,b)=>a+b,0);
      return {
        label:`${s.salon}: $${Number(total).toLocaleString()}`,
        data:s.data.map(v=>parseFloat(v||0)),
        backgroundColor:COLORS[idx%COLORS.length],
        borderColor:COLORS[idx%COLORS.length],
        borderWidth:1,
        borderSkipped:false
      }
    });

    const ctx = document.getElementById("salonesIncomeChart").getContext("2d");
    if(incomeChart) incomeChart.destroy();
    incomeChart = new Chart(ctx,{
      type:"bar",
      data:{labels, datasets},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{
          legend:{
            display:true,
            position:'right',
            align:'start',
            labels:{color:"#ddd", boxWidth:25, boxHeight:12, padding:24}
          },
          tooltip:{
            callbacks:{
              label: ctx => `$ ${Number(ctx.raw).toLocaleString()}`
            }
          }
        },
        scales:{
          x:{ticks:{color:"#ccc"}},
          y:{ticks:{color:"#ccc", callback:v=>v?Number(v).toLocaleString():v}}
        }
      }
    });
  }

  function hexToRgba(hex, alpha){
    const h = hex.replace('#',''), bigint=parseInt(h,16);
    const r=(bigint>>16)&255, g=(bigint>>8)&255, b=bigint&255;
    return `rgba(${r},${g},${b},${alpha})`;
  }

  // Button listeners
  document.getElementById("btnSemana").onclick = ()=>{ periodo="semana"; activarBoton("filtro-periodo","btnSemana"); cargarSalonesCharts(); };
  document.getElementById("btnMes").onclick = ()=>{ periodo="mes"; activarBoton("filtro-periodo","btnMes"); cargarSalonesCharts(); };

  // === DESCARGAS: XLSX / CSV / PDF ===
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.getElementById("btnXLSX").addEventListener("click", () => {
    const url = `/descargar/xlsx/?tipo=salones&periodo=${encodeURIComponent(periodo)}`;
    window.location.href = url;
  });

  document.getElementById("btnCSV").addEventListener("click", () => {
    const url = `/descargar/csv/?tipo=salones&periodo=${encodeURIComponent(periodo)}`;
    window.location.href = url;
  });

  document.getElementById("btnPDF").addEventListener("click", async (e) => {
    e.preventDefault();
    const url = `/descargar/pdf/?tipo=salones&periodo=${encodeURIComponent(periodo)}`;
    const csrf = getCookie('csrftoken');
    
    console.log("CSRF Token:", csrf); // DEBUG

    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrf
        },
        body: JSON.stringify({ periodo: periodo })
      });
      
      if (!resp.ok) {
        const text = await resp.text().catch(()=>"Sin detalles");
        console.error("PDF error", resp.status, text);
        alert(`Error generando PDF (${resp.status}). Revisa la consola del navegador.`);
        return;
      }
      
      const blob = await resp.blob();
      const filename = `salones_${periodo}.pdf`;
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(link.href);
    } catch (err) {
      console.error("Error descargando PDF:", err);
      alert("Error descargando PDF (ver consola).");
    }
  });

  // Initialize
  activarBoton("filtro-periodo","btnSemana");
  cargarSalonesCharts();
</script>

{% endblock %}
