{% extends 'admin_custom/base_admin.html' %}
{% load static %}

{% block header %}
Gestión de Salones
{% endblock %}

{% block content %}
<div class="p-6 bg-gray-900 min-h-screen text-gray-100">
    <div class="flex justify-end items-center mb-4 -mt-2">
        <button id="btnNuevoSalon"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition shadow-md font-medium">
            + Nuevo Salón
        </button>
    </div>

    <div class="overflow-x-auto rounded-lg shadow-lg border border-gray-800">
        <table class="w-full border-collapse">
            <thead class="bg-gray-800 text-gray-300">
                <tr>
                    <th class="py-3 px-4 text-left font-medium">Imagen</th>
                    <th class="py-3 px-4 text-left font-medium">Nombre</th>
                    <th class="py-3 px-4 text-left font-medium">Categoría</th>
                    <th class="py-3 px-4 text-left font-medium">Capacidad</th>
                    <th class="py-3 px-4 text-left font-medium">Precio</th>
                    <th class="py-3 px-4 text-left font-medium">Ciudad</th>
                    <th class="py-3 px-4 text-left font-medium">Calificación</th>
                    <th class="py-3 px-4 text-center font-medium">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for salon in salones %}
                <tr id="row-{{ salon.id }}" class="border-b border-gray-800">
                    <td class="py-3 px-4">
                        {% if salon.imagen %}
                        <img src="{{ salon.imagen.url }}" alt="{{ salon.nombre }}"
                            class="w-20 h-16 object-cover rounded-lg">
                        {% else %}
                        <div
                            class="w-20 h-16 bg-gray-700 flex items-center justify-center rounded-lg text-gray-400 text-sm">
                            No img</div>
                        {% endif %}
                    </td>
                    <td class="py-3 px-4">{{ salon.nombre }}</td>
                    <td class="py-3 px-4 capitalize">{{ salon.get_categoria_display }}</td>
                    <td class="py-3 px-4">{{ salon.capacidad }}</td>
                    <td class="py-3 px-4">${{ salon.precio }}</td>
                    <td class="py-3 px-2">{{ salon.ciudad }}</td>
                    <td class="py-3 px-12">{{ salon.calificacion }}</td>
                    
                    <td class="py-3 px-4 text-center">
                        <button data-id="{{ salon.id }}"
                            class="btnEditar bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded-md text-sm">
                            Editar
                        </button>
                        <button data-id="{{ salon.id }}"
                            class="btnEliminar bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm ml-2">
                            Eliminar
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-6 text-gray-500">No hay salones registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal principal -->
<div id="modalSalon" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50">
    <div class="bg-gray-800 w-full max-w-lg rounded-xl p-6 shadow-2xl">
        <h2 id="modalTitle" class="text-xl font-semibold text-white mb-4">Nuevo Salón</h2>
        <form id="formSalon" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" id="salonId">
            <div class="space-y-3">
                <div>
                    <label class="block text-gray-300 text-sm mb-1">Nombre</label>
                    <input type="text" name="nombre"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-600">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm mb-1">Descripción</label>
                    <textarea name="descripcion" rows="3"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-600"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 text-sm mb-1">Capacidad</label>
                        <input type="number" name="capacidad"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100">
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm mb-1">Precio</label>
                        <input type="number" step="0.01" name="precio"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100">
                    </div>
                </div>
                <div>
                    <label class="block text-gray-300 text-sm mb-1">Calificación</label>
                    <input type="text" name="calificacion" inputmode="decimal" maxlength="3" placeholder="0.0 - 5.0"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100">
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-1">Categoría</label>
                    <select name="categoria"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100">
                        <option value="reuniones">Reuniones</option>
                        <option value="expos">Expos</option>
                        <option value="fiestas">Fiestas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 text-sm mb-1">Ciudad</label>
                    <input type="text" name="ciudad"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm mb-1">Imagen</label>
                    <input type="file" name="imagen"
                        class="w-full text-gray-100 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btnCerrarModal"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-gray-200">Cancelar</button>
                <button type="submit"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div id="modalEliminar" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 shadow-2xl w-full max-w-md">
        <h2 class="text-xl text-white font-semibold mb-4">Confirmar eliminación</h2>
        <p class="text-gray-300 mb-6">¿Seguro que deseas eliminar este salón?</p>
        <div class="flex justify-end space-x-3">
            <button id="cancelarEliminar"
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg">Cancelar</button>
            <button id="confirmarEliminar"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Eliminar</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("modalSalon");
        const modalEliminar = document.getElementById("modalEliminar");
        const modalTitle = document.getElementById("modalTitle");
        const form = document.getElementById("formSalon");
        const btnCerrar = document.getElementById("btnCerrarModal");
        let salonAEliminar = null;

        // ✅ Success modal
        const modalSuccess = document.createElement("div");
        modalSuccess.className = "fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50";
        modalSuccess.innerHTML = `
        <div class="bg-gray-800 rounded-xl p-6 shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-xl text-white font-semibold mb-3">¡Éxito!</h2>
            <p class="text-gray-300 mb-6">El salón se ha guardado correctamente.</p>
            <button id="btnCerrarSuccess" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">Aceptar</button>
        </div>
    `;
        document.body.appendChild(modalSuccess);

        function showSuccessModal() {
            modalSuccess.classList.remove("hidden");
            modalSuccess.classList.add("flex");
        }

        document.getElementById("btnCerrarSuccess").addEventListener("click", () => {
            modalSuccess.classList.add("hidden");
            location.reload();
        });

        // ✅ Helper functions
        function openModal(title) {
            modalTitle.textContent = title;
            modal.classList.remove("hidden");
            modal.classList.add("flex");
        }
        function closeModal() {
            modal.classList.add("hidden");
            clearValidationErrors();
        }
        function openDeleteModal(id) {
            salonAEliminar = id;
            modalEliminar.classList.remove("hidden");
            modalEliminar.classList.add("flex");
        }
        function closeDeleteModal() {
            modalEliminar.classList.add("hidden");
            salonAEliminar = null;
        }

        function clearValidationErrors() {
            form.querySelectorAll(".error-message").forEach(el => el.remove());
            form.querySelectorAll(".border-red-500").forEach(input => {
                input.classList.remove("border-red-500");
            });
        }

        function showValidationErrors(errors) {
            clearValidationErrors();
            for (const [field, msgs] of Object.entries(errors)) {
                const input = form.querySelector(`[name='${field}']`);
                if (input) {
                    input.classList.add("border-red-500");
                    const errorMsg = document.createElement("p");
                    errorMsg.className = "error-message text-red-500 text-sm mt-1";
                    errorMsg.textContent = msgs[0];
                    input.insertAdjacentElement("afterend", errorMsg);
                }
            }
        }

        btnCerrar.addEventListener("click", closeModal);
        document.getElementById("cancelarEliminar").addEventListener("click", closeDeleteModal);

        // ✅ Nuevo salón
        document.getElementById("btnNuevoSalon").addEventListener("click", () => {
            form.reset();
            clearValidationErrors();
            document.getElementById("salonId").value = "";
            form.dataset.action = "/admin/salones/nuevo/";
            openModal("Nuevo Salón");
        });

        // ✅ Editar salón
        document.querySelectorAll(".btnEditar").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                const res = await fetch(`/admin/salones/editar/${id}/`);
                const data = await res.json();
                const salon = data.salon;

                ["nombre", "descripcion", "capacidad", "precio", "calificacion", "categoria", "ciudad"].forEach(k => {
                    const input = form.querySelector(`[name='${k}']`);
                    if (input) input.value = salon[k] ?? "";
                });

                document.getElementById("salonId").value = id;
                form.dataset.action = `/admin/salones/editar/${id}/`;
                openModal("Editar Salón");
            });
        });

        // ✅ Mostrar modal de confirmación al eliminar
        document.querySelectorAll(".btnEliminar").forEach(btn => {
            btn.addEventListener("click", () => openDeleteModal(btn.dataset.id));
        });

        // ✅ Confirmar eliminación
        document.getElementById("confirmarEliminar").addEventListener("click", async () => {
            if (!salonAEliminar) return;
            const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
            const res = await fetch(`/admin/salones/eliminar/${salonAEliminar}/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
            });
            const result = await res.json();
            if (result.success) location.reload();
            else alert("Error al eliminar el salón.");
            closeDeleteModal();
        });

        // ✅ Guardar o editar salón con validación y modal de éxito
        form.addEventListener("submit", async e => {
            e.preventDefault();
            clearValidationErrors();

            const res = await fetch(form.dataset.action, {
                method: "POST",
                body: new FormData(form)
            });
            const result = await res.json();

            if (result.success) {
                closeModal();
                showSuccessModal();
            } else if (result.errors) {
                showValidationErrors(result.errors);
            } else {
                alert("Error desconocido al guardar el salón.");
            }
        });

        // ✅ Calificación: inserta el punto automáticamente y permite editar/borrar libremente
        const calificacionInput = document.querySelector("input[name='calificacion']");

        if (calificacionInput) {
            calificacionInput.type = "text"; // ⚠️ override to text for JS control
            calificacionInput.inputMode = "decimal";
            calificacionInput.maxLength = 3;
            calificacionInput.placeholder = "0.0 - 5.0";

            calificacionInput.addEventListener("input", (e) => {
                let val = e.target.value.replace(/[^0-9]/g, ""); // keep digits only

                if (val.length === 0) {
                    e.target.value = "";
                    return;
                }

                if (val.length === 1) {
                    e.target.value = val;
                } else {
                    e.target.value = val[0] + "." + val[1];
                }

                // limit max to 5.0
                const num = parseFloat(e.target.value);
                if (num > 5) e.target.value = "5.0";
            });
        }
    });
</script>




{% endblock %}