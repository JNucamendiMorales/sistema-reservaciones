{% extends "admin_custom/base_admin.html" %}
{% load static %}

{% block title %}Gr√°ficos de Reservaciones{% endblock %}
{% block header %}Gr√°ficos de Reservaciones{% endblock %}

{% block content %}
<div class="flex flex-wrap gap-8 items-start overflow-hidden">

  <!-- === GRID PRINCIPAL === -->
  <div class="flex flex-wrap gap-6">
    <!-- Tarjeta de barras -->
    <div
      class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-lg h-72 w-[550px]">
      <h5 id="barTitle" class="text-gray-400 text-sm mb-2">Reservaciones por periodo</h5>
      <div class="h-full w-full">
        <canvas id="barChart" class="h-full w-full" style="padding-bottom: 1.5rem;"></canvas>
      </div>
    </div>

    <!-- Tarjeta de pastel -->
    <div
      class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-lg h-72 w-[640px]">
      <h5 id="pieTitle" class="text-gray-400 text-sm mb-2">Salones m√°s reservados</h5>
      <div class="flex items-start min-h-0 h-full">
        <div class="flex-shrink-0 mr-4 self-start">
          <canvas id="pieChart" style="max-width: 200px;"></canvas>
        </div>

        <!-- Leyenda scrollable -->
        <div class="flex-1 pl-2 pr-0">
          <div id="pieLegendContainer" class="allow-scroll custom-scroll"
            style="max-height:12rem; padding-right:0.4rem;"></div>
        </div>

      </div>
    </div>




    <!-- Contenedor principal: tarjeta + botones a la derecha -->
    <div class="flex flex-nowrap gap-8 items-start">

      <!-- Tarjeta de l√≠neas -->
      <div
        class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-lg h-[300px] w-[800px]">
        <h5 id="lineTitle" class="text-gray-400 text-sm mb-2">Ingresos por periodo</h5>
        <div class="h-full w-full">
          <canvas id="lineChart" class="h-full w-full"></canvas>
        </div>
      </div>

      <!-- Contenedor de botones -->
      <div class="flex flex-col justify-start space-y-8 mt-4">

        <!-- Grupo: Periodo -->
        <div class="flex flex-col items-start space-y-2">
          <span class="text-gray-300 font-medium text-lg">Periodo</span>
          <div class="flex space-x-3">
            <button id="btnSemana"
              class="px-4 py-2 bg-indigo-600 rounded-lg text-white font-semibold text-sm hover:bg-indigo-500 transition">üóìÔ∏è
              Semanal</button>
            <button id="btnMes"
              class="px-4 py-2 bg-gray-700 rounded-lg text-gray-200 font-semibold text-sm hover:bg-gray-600 transition">üìÖ
              Mensual</button>
          </div>
        </div>



        <!-- Grupo: Descargar -->
        <div class="flex flex-col items-start space-y-2">
          <span class="text-gray-300 font-medium text-lg">Descargar</span>
          <div class="flex space-x-3">
            <button id="btnXLSX"
              class="px-4 py-2 bg-blue-600 rounded-lg text-white font-semibold text-sm hover:bg-blue-500 transition">üìä
              XLSX</button>
            <button id="btnCSV"
              class="px-4 py-2 bg-blue-600 rounded-lg text-white font-semibold text-sm hover:bg-blue-500 transition">üóÉÔ∏è
              CSV</button>
            <button id="btnPDF"
              class="px-4 py-2 bg-blue-600 rounded-lg text-white font-semibold text-sm hover:bg-blue-500 transition">üìÑ
              PDF</button>
          </div>
        </div>

      </div>
    </div>



  </div>


</div>







<!-- === Estilos del scroll minimalista === -->
<style>
  .custom-scroll::-webkit-scrollbar {
    width: 6px;
  }

  .custom-scroll::-webkit-scrollbar-track {
    background: #1f2937;
    border-radius: 3px;
  }

  .custom-scroll::-webkit-scrollbar-thumb {
    background-color: #4b5563;
    border-radius: 3px;
  }

  .custom-scroll {
    scrollbar-width: thin;
    scrollbar-color: #4b5563 #1f2937;
  }

  /* --- Layout wrapper para evitar scroll de p√°gina --- */
  .chart-root {
    box-sizing: border-box;
    height: calc(100vh - 4rem);
    /* ajusta si el header ocupa m√°s */
    overflow: hidden;
    padding: 1.5rem;
  }

  .chart-content {
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    overflow: hidden;
  }
</style>

<!-- === Chart.js CDN y JS de gr√°ficos === -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const charts = {};
    let periodo = "semana";
    const visibleWithoutScroll = 11;
    const weekdayNames = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];

    async function renderGraficas() {
      try {
        const resp = await fetch(`{% url 'obtener_datos_reservaciones' %}?periodo=${periodo}`);
        const data = await resp.json();

        // Actualizar t√≠tulos visibles seg√∫n periodo
        if (periodo === "semana") {
          document.getElementById("barTitle").innerText = "N√∫mero de reservaciones semanalmente";
          document.getElementById("pieTitle").innerText = "Salones m√°s reservados semanalmente";
          document.getElementById("lineTitle").innerText = "Ingresos semanalmente";
        } else {
          document.getElementById("barTitle").innerText = "N√∫mero de reservaciones mensualmente";
          document.getElementById("pieTitle").innerText = "Salones m√°s reservados mensualmente";
          document.getElementById("lineTitle").innerText = "Ingresos mensualmente";
        }

        // --- Gr√°fico de Barras ---
        const barCtx = document.getElementById("barChart").getContext("2d");
        if (charts.bar) charts.bar.destroy();

        let barLabels, barValues;

        if (periodo === "semana") {
            // data.por_dia debe venir con etiquetas Lunes..Domingo (ver backend)
            barLabels = data.por_dia.map(d => d.fecha_reserva);
            barValues = data.por_dia.map(d => d.total);
        } else {
            barLabels = ["1-5","6-10","11-15","16-20","21-25","26-31"];
            barValues = data.por_dia.map(d => d.total);
        }

        charts.bar = new Chart(barCtx, {
            type: "bar",
            data: {
                labels: barLabels,
                datasets: [{
                    label: periodo === "semana" ? "N√∫mero de reservaciones semanalmente" : "N√∫mero de reservaciones mensualmente",
                    data: barValues,
                    backgroundColor: "rgba(99,102,241,0.6)",
                    borderColor: "rgba(99,102,241,1)",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { bottom: 16 } },
                scales: {
                    x: {
                        ticks: { color: "#cbd5e1", font: { family: "'Inter', sans-serif", weight: "bold", size: 12 } },
                        grid: { color: "rgba(255,255,255,0.05)" },
                        offset: true
                    },
                    y: {
                        ticks: { color: "#cbd5e1", stepSize: 2, font: { family: "'Inter', sans-serif", weight: "bold", size: 12 } },
                        grid: { color: "rgba(255,255,255,0.05)" }
                    }
                }
            }
        });

        // --- Gr√°fico de Pastel ---
        const pieCtx = document.getElementById("pieChart").getContext("2d");
        if (charts.pie) charts.pie.destroy();

        const salonLabels = data.por_salon.map(s =>
          s.salon__nombre.replace(/sal[o√≥]n\s*/i, '').replace(/\s*\d+$/, '')
        );
        const salonTotals = data.por_salon.map(s => s.total);

        charts.pie = new Chart(pieCtx, {
          type: "pie",
          data: {
            labels: salonLabels,
            datasets: [{
              data: salonTotals,
              backgroundColor: [
                "#6366F1", "#22C55E", "#EAB308", "#F97316", "#EF4444",
                "#3B82F6", "#A855F7", "#10B981", "#F59E0B", "#8B5CF6",
                "#EC4899", "#F43F5E", "#3B82F6", "#6366F1", "#22C55E",
                "#F97316", "#EF4444", "#A855F7", "#10B981", "#F59E0B",
                "#8B5CF6", "#EC4899", "#F43F5E", "#3B82F6", "#6366F1"
              ],
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, title: { display: false } }
          }
        });

        // --- Leyenda scrollable funcional ---
        const legendContainer = document.getElementById("pieLegendContainer");
        legendContainer.innerHTML = "";
        legendContainer.style.display = "block";
        legendContainer.style.maxHeight = "12rem";
        legendContainer.style.overflowY = "auto";
        legendContainer.style.paddingRight = "0.5rem";

        const itemsPerColumn = visibleWithoutScroll;
        const numColumns = Math.ceil(salonLabels.length / itemsPerColumn);

        for (let c = 0; c < numColumns; c++) {
          const col = document.createElement("ul");
          col.style.listStyle = "none";
          col.style.margin = "0";
          col.style.padding = "0";
          col.style.display = "inline-block";
          col.style.verticalAlign = "top";
          col.style.marginRight = "1rem";

          const start = c * itemsPerColumn;
          const end = start + itemsPerColumn;

          salonLabels.slice(start, end).forEach((label, i) => {
            const li = document.createElement("li");
            li.style.display = "flex";
            li.style.alignItems = "center";
            li.style.gap = "0.5rem";
            li.innerHTML = `<span style="background-color:${charts.pie.data.datasets[0].backgroundColor[start + i]};width:12px;height:12px;display:inline-block;border-radius:2px;"></span>
                    <span style="color:#e5e7eb;font-size:0.75rem;">${label}</span>`;
            col.appendChild(li);
          });

          legendContainer.appendChild(col);
        }

        // --- Gr√°fico de L√≠neas (Ingresos) ---
        const lineCtx = document.getElementById("lineChart").getContext("2d");
        if (charts.line) charts.line.destroy();

        let lineLabels, lineValues;

        if (periodo === "semana") {
            // Queremos Lunes..Domingo con totales de ingresos por d√≠a (llenar con ceros si falta)
            lineLabels = weekdayNames.slice();
            const valores = [0,0,0,0,0,0,0];

            // data.ingresos_por_dia expected: { fecha_reserva: "YYYY-MM-DD" (o ISO), total: number }
            for (const item of data.ingresos_por_dia) {
                // intentar parsear fecha; si ya es etiqueta, intentar mapear por nombre
                let diaIndex = null;
                if (item.fecha_reserva && !isNaN(Date.parse(item.fecha_reserva))) {
                    const d = new Date(item.fecha_reserva);
                    // JS getDay(): 0=Domingo..6=S√°bado -> queremos 0=Lunes..6=Domingo
                    diaIndex = (d.getDay() + 6) % 7;
                } else {
                    // si backend devolvi√≥ nombre, buscar √≠ndice directo
                    const idx = weekdayNames.findIndex(n => n.toLowerCase().startsWith(String(item.fecha_reserva).toLowerCase()));
                    if (idx >= 0) diaIndex = idx;
                }
                if (diaIndex !== null && !isNaN(Number(item.total))) {
                    valores[diaIndex] += Number(item.total);
                }
            }
            lineValues = valores;
        } else {
            // Mensual: mantener ejes por d√≠a del mes (backend devuelve lista por d√≠a/rango)
            lineLabels = data.ingresos_por_dia.map(d => d.fecha_reserva);
            lineValues = data.ingresos_por_dia.map(d => d.total);
        }

        charts.line = new Chart(lineCtx, {
          type: "line",
          data: {
            labels: lineLabels,
            datasets: [{
              label: periodo === "semana" ? "Ingresos semanalmente" : "Ingresos mensualmente",
              data: lineValues,
              borderColor: "#EAB308",
              backgroundColor: "rgba(234,179,8,0.2)",
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { bottom: 16, left: 16, right: 16, top: 16 } },
            scales: {
              x: {
                ticks: { color: "#cbd5e1", font: { family: "'Inter', sans-serif", weight: "bold", size: 12 } },
                grid: { color: "rgba(255,255,255,0.05)" },
                offset: true
              },
              y: {
                ticks: { color: "#cbd5e1", font: { family: "'Inter', sans-serif", weight: "bold", size: 12 } },
                grid: { color: "rgba(255,255,255,0.05)" }
              }
            }
          }
        });


      } catch (err) {
        console.error("Error al cargar las gr√°ficas:", err);
      }
    }

    renderGraficas();

    // --- Botones periodo ---
    document.getElementById("btnSemana").addEventListener("click", () => { periodo = "semana"; actualizarBotonesPeriodo(); renderGraficas(); });
    document.getElementById("btnMes").addEventListener("click", () => { periodo = "mes"; actualizarBotonesPeriodo(); renderGraficas(); });


    // --- Funci√≥n para obtener las im√°genes de los charts ---
    function getChartImages() {
      return {
        bar: charts.bar.toBase64Image(),
        pie: charts.pie.toBase64Image(),
        line: charts.line.toBase64Image()
      };
    }

    // Helper CSRF
    function getCookie(name) {
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }

    // --- Bot√≥n PDF: enviar FormData con bar/pie/line ---
    document.getElementById("btnPDF").addEventListener("click", async () => {
      try {
        const images = getChartImages();
        const formData = new FormData();
        // Enviar con las claves que export_pdf espera
        formData.append("reservaciones", images.bar);
        formData.append("salones_mas_reservados", images.pie);
        formData.append("ingresos", images.line);
        formData.append("fecha", new Date().toLocaleString());
        formData.append("charts", "Reservaciones,Salones mas reservados,Ingresos");
        formData.append("periodo", periodo);  // <-- AGREGAR ESTO

        const response = await fetch("{% url 'descargar_reportes' 'pdf' %}", {
          method: "POST",
          body: formData,
          credentials: "same-origin",
          headers: { "X-CSRFToken": getCookie("csrftoken") }
        });

        if (!response.ok) {
          const txt = await response.text();
          console.error("Error al generar PDF:", response.status, txt);
          alert("Error al generar PDF: " + txt);
          return;
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "reservaciones_periodo.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        console.error("Error en descarga PDF:", err);
        alert("Error al generar PDF");
      }
    });




    function actualizarBotonesPeriodo() {
      const semana = document.getElementById("btnSemana");
      const mes = document.getElementById("btnMes");
      if (periodo === "semana") { semana.classList.replace("bg-gray-700", "bg-indigo-600"); mes.classList.replace("bg-indigo-600", "bg-gray-700"); }
      else { mes.classList.replace("bg-gray-700", "bg-indigo-600"); semana.classList.replace("bg-indigo-600", "bg-gray-700"); }
    }



    document.getElementById("btnCSV").addEventListener("click", () => {
      window.location.href =
        "{% url 'descargar_reportes' 'csv' %}" + "?periodo=" + periodo;
    });

    document.getElementById("btnXLSX").addEventListener("click", () => {
      window.location.href =
        "{% url 'descargar_reportes' 'xlsx' %}" + "?periodo=" + periodo;
    });




  });
</script>

<style>
  /* Quita el scroll completamente */
  html,
  body {
    overflow: hidden !important;
    height: 100%;
  }

  /* Evita que los divs internos causen overflow */
  * {
    box-sizing: border-box;
    max-width: 100vw;
  }

  /* Corrige posibles m√°rgenes que empujan contenido */
  body {
    margin: 0;
    padding: 0;
  }

  /* En caso de que la gr√°fica est√© causando el overflow */
  canvas {
    display: block;
    max-width: 100%;
    height: auto;
  }
</style>



{% endblock %}