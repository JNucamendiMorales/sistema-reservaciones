{% extends "admin_custom/base_admin.html" %}
{% load static %}

{% block title %}Gr√°ficos de Usuarios{% endblock %}
{% block header %}Gr√°ficos de Usuarios{% endblock %}

{% block content %}
<div class="flex flex-wrap gap-8 items-start overflow-hidden">

  <!-- === GRID PRINCIPAL === -->
  <div class="flex flex-wrap gap-6">

    <!-- 1Ô∏è‚É£ NUEVOS USUARIOS REGISTRADOS (Pastel) -->
    <div class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-lg h-64 w-[500px]">
      <h5 class="text-gray-400 text-sm mb-4">Nuevos usuarios registrados</h5>
      <div class="flex items-start justify-between h-full">
        <!-- Canvas -->
        <div class="flex-shrink-0 self-start">
          <canvas id="usuariosPieChart" style="width:100%;height:180px;"></canvas>
        </div>

        <!-- Leyenda -->
        <div id="usuariosPieLegend" style="transform: translateX(-12px);" class="text-sm text-gray-300 flex flex-col justify-center space-y-1"></div>


      </div>
    </div>

    <!-- 3Ô∏è‚É£ USUARIOS M√ÅS ACTIVOS (Barras) -->
    <div class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-lg h-64 w-[640px] ml-1">
      <h5 class="text-gray-400 text-sm mb-2">Usuarios con mas Reservaciones</h5>
      <div class="h-full w-full">
        <canvas id="usuariosBarChart" class="h-full w-full"></canvas>
      </div>
    </div>

  </div>

  <!-- Tarjeta + botones -->
  <div class="flex flex-nowrap gap-8 items-start">

    <!-- 2Ô∏è‚É£ USUARIOS CON MAYORES INGRESOS (L√≠neas) -->
    <div class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-lg h-[320px] w-[800px]">
      <h5 class="text-gray-400 text-sm mb-3">üìà Usuarios con mayores ingresos</h5>
      <div class="h-full w-full">
        <canvas id="usuariosLineChart" class="h-full w-full"></canvas>
      </div>
    </div>

    <!-- === BOTONES DE FILTRO === -->
    <div class="flex flex-col justify-start space-y-8 mt-4">

      <!-- Grupo: Periodo -->
      <div class="flex flex-col items-start space-y-2">
        <span class="text-gray-300 font-medium text-lg">Periodo</span>
        <div class="flex space-x-3">
          <button id="btnSemana" class="filtro-periodo px-4 py-2 rounded-lg text-white font-semibold text-sm transition bg-indigo-600">üóìÔ∏è Semanal</button>
          <button id="btnMes" class="filtro-periodo px-4 py-2 rounded-lg text-gray-200 font-semibold text-sm bg-gray-700 hover:bg-gray-600 transition">üìÖ Mensual</button>
        </div>
      </div>

      <!-- Grupo: Descargar (sin An√°lisis/Mejor-Peor) -->
      <div class="flex flex-col items-start space-y-2">
        <span class="text-gray-300 font-medium text-lg">Descargar</span>
        <div class="flex space-x-3">
          <button id="btnXLSX" class="px-4 py-2 bg-blue-600 rounded-lg text-white font-semibold text-sm hover:bg-blue-500 transition">üìä XLSX</button>
          <button id="btnCSV" class="px-4 py-2 bg-blue-600 rounded-lg text-white font-semibold text-sm hover:bg-blue-500 transition">üóÉÔ∏è CSV</button>
          <button id="btnPDF" class="px-4 py-2 bg-blue-600 rounded-lg text-white font-semibold text-sm hover:bg-blue-500 transition">üìÑ PDF</button>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
html, body { overflow: hidden !important; height: 100%; }
* { box-sizing: border-box; max-width: 100vw; }
body { margin: 0; padding: 0; }
canvas { display: block; max-width: 100%; height: auto; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let periodo = "semana";
const TIPO = "usuarios";
  
let pieChart, usuariosBarChart, ingresosBarChart; // renombrado: dos barras

async function cargarDatos() {
  const res = await fetch(`/api/datos_usuarios/?periodo=${periodo}`);
  const data = await res.json();
  actualizarGraficas(data);
}

function actualizarGraficas(data) {
  const nuevos = data.nuevos_usuarios || [];
  const ingresos = data.usuarios_ingresos || [];
  const activos = data.usuarios_activos || [];

  // --- PIE CHART ---
  const pieCtx = document.getElementById("usuariosPieChart").getContext("2d");
  if (pieChart) pieChart.destroy();

  const labels = nuevos.map(u => u.fecha);
  const filledData = nuevos.map(u => parseInt(u.total || 0));

  pieChart = new Chart(pieCtx, {
    type:"pie",
    data:{ 
      labels: labels, 
      datasets:[{ 
        data: filledData, 
        backgroundColor:["#4F46E5","#22C55E","#EAB308","#F97316","#EF4444","#14B8A6","#A855F7"] 
      }] 
    },
    options:{ 
      responsive:true, 
      maintainAspectRatio:false, 
      plugins:{legend:{display:false}}, 
      layout:{padding:10} 
    }
  });

  // Manual legend
  const legend = document.getElementById("usuariosPieLegend");
  legend.innerHTML = labels.map((label, i) => {
    const color = pieChart.data.datasets[0].backgroundColor[i % 7];
    return `
      <div class="flex items-center">
          <span style="background-color:${color}; width:12px; height:12px; display:inline-block; border-radius:3px; margin-right:8px;"></span>
          <span>${label}: </span>
          <strong style="margin-left:6px;">${filledData[i]}</strong>
      </div>
    `;
  }).join("");

  // --- INGRESOS (AHORA BARRAS) ---
  const ingresosCtx = document.getElementById("usuariosLineChart").getContext("2d");
  if (ingresosBarChart) ingresosBarChart.destroy();

  ingresosBarChart = new Chart(ingresosCtx, {
    type: "bar",
    data: {
      labels: ingresos.map(u => u.usuario),
      datasets: [{
        label: "Ingresos (MXN)",
        data: ingresos.map(u => parseFloat(u.total)),
        backgroundColor: "#22C55E"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: "#ddd" } } },
      layout: { padding: 10 },
      scales: {
        x: { ticks: { color: "#ccc" }, position: 'bottom' },
        y: { ticks: { color: "#ccc" } }
      }
    }
  });

  // --- BAR CHART (Usuarios activos) ---
  const barCtx = document.getElementById("usuariosBarChart").getContext("2d");
  if (usuariosBarChart) usuariosBarChart.destroy();

  usuariosBarChart = new Chart(barCtx, {
    type: "bar",
    data: {
      labels: activos.map(u => u.usuario),
      datasets: [{
        label: "Reservaciones",
        data: activos.map(u => u.total),
        backgroundColor: "#3B82F6"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: "#ddd" } } },
      layout: { padding: 10 },
      scales: {
        x: { ticks: { color: "#ccc" }, position: 'bottom' },
        y: { ticks: { color: "#ccc" } }
      }
    }
  });

}

function activarBotonPeriodo(){
    const semana = document.getElementById("btnSemana");
    const mes = document.getElementById("btnMes");
    if (periodo === "semana") { semana.classList.replace("bg-gray-700","bg-indigo-600"); mes.classList.replace("bg-indigo-600","bg-gray-700"); }
    else { mes.classList.replace("bg-gray-700","bg-indigo-600"); semana.classList.replace("bg-indigo-600","bg-gray-700"); }
  }

  document.getElementById("btnSemana").onclick = ()=>{ periodo="semana"; activarBotonPeriodo(); cargarDatos(); };
  document.getElementById("btnMes").onclick = ()=>{ periodo="mes"; activarBotonPeriodo(); cargarDatos(); };

  // --- Descargas: XLSX / CSV / PDF (mismo comportamiento que Reservaciones, con tipo=usuarios) ---
  document.getElementById("btnCSV").addEventListener("click", () => {
    window.location.href = "{% url 'descargar_reportes' 'csv' %}" + "?periodo=" + periodo + "&tipo=" + TIPO;
  });
  
  document.getElementById("btnXLSX").addEventListener("click", () => {
    window.location.href = "{% url 'descargar_reportes' 'xlsx' %}" + "?periodo=" + periodo + "&tipo=" + TIPO;
  });
  
  // PDF: enviar im√°genes como form-data (bar,pie,line) + tipo + periodo
  function getChartImages() {
    return {
      bar: usuariosBarChart ? usuariosBarChart.toBase64Image() : null,
      pie: pieChart ? pieChart.toBase64Image() : null,
      line: ingresosBarChart ? ingresosBarChart.toBase64Image() : null  // mantiene clave 'line' por compatibilidad
    };
  }
  
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  
  document.getElementById("btnPDF").addEventListener("click", async () => {
    try {
      const images = getChartImages();
      const formData = new FormData();
      formData.append("bar", images.bar);
      formData.append("pie", images.pie);
      formData.append("line", images.line);
      formData.append("periodo", periodo);
      formData.append("tipo", TIPO);
      formData.append("fecha", new Date().toLocaleString());
  
      const response = await fetch("{% url 'descargar_reportes' 'pdf' %}", {
        method: "POST",
        body: formData,
        credentials: "same-origin",
        headers: { "X-CSRFToken": getCookie("csrftoken") }
      });
  
      if (!response.ok) {
        const txt = await response.text();
        console.error("Error al generar PDF:", response.status, txt);
        alert("Error al generar PDF: " + txt);
        return;
      }
  
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "usuarios_periodo.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error("Error en descarga PDF:", err);
      alert("Error al generar PDF");
    }
  });
  
 // Inicial
 cargarDatos();
</script>

{% endblock %}
