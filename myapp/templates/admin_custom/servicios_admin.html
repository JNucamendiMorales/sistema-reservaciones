{% extends 'admin_custom/base_admin.html' %}
{% load static %}

{% block header %}
Gestión de Servicios Extras
{% endblock %}

{% block content %}
<div class="p-6 bg-gray-900 min-h-screen text-gray-100">
    <div class="flex justify-end items-center mb-4 -mt-2">
        <button id="btnNuevoServicio"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition shadow-md font-medium">
            + Nuevo Servicio
        </button>
    </div>

    <div class="overflow-x-auto rounded-lg shadow-lg border border-gray-800">
        <table class="w-full border-collapse">
            <thead class="bg-gray-800 text-gray-300">
                <tr>
                    <th class="py-3 px-4 text-left font-medium">Imagen</th>
                    <th class="py-3 px-4 text-left font-medium">Nombre</th>
                    <th class="py-3 px-4 text-left font-medium">Tipo de Salón</th>
                    <th class="py-3 px-4 text-left font-medium">Precio</th>
                    <th class="py-3 px-4 text-center font-medium">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for servicio in servicios %}
                <tr id="row-{{ servicio.id }}" class="border-b border-gray-800">
                    <td class="py-3 px-4">
                        {% if servicio.imagen %}
                        <img src="{{ servicio.imagen.url }}" alt="{{ servicio.nombre }}"
                            class="w-20 h-16 object-cover rounded-lg">
                        {% else %}
                        <div class="w-20 h-16 bg-gray-700 flex items-center justify-center rounded-lg text-gray-400 text-sm">
                            No img
                        </div>
                        {% endif %}
                    </td>
                    <td class="py-3 px-4">{{ servicio.nombre }}</td>
                    <td class="py-3 px-4 capitalize">{{ servicio.get_tipo_salon_display }}</td>
                    <td class="py-3 px-4">${{ servicio.precio }}</td>
                    <td class="py-3 px-4 text-center">
                        <button data-id="{{ servicio.id }}"
                            class="btnEditar bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded-md text-sm">
                            Editar
                        </button>
                        <button data-id="{{ servicio.id }}"
                            class="btnEliminar bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm ml-2">
                            Eliminar
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-6 text-gray-500">No hay servicios registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nuevo / Editar Servicio -->
<div id="modalServicio" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50">
    <div class="bg-gray-800 w-full max-w-lg rounded-xl p-6 shadow-2xl">
        <h2 id="modalTitle" class="text-xl font-semibold text-white mb-4">Nuevo Servicio</h2>
        <form id="formServicio" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" id="servicioId">
            <div class="space-y-3">
                <div>
                    <label class="block text-gray-300 text-sm mb-1">Nombre</label>
                    <input type="text" name="nombre"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-600">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm mb-1">Precio</label>
                    <input type="number" step="0.01" name="precio"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm mb-1">Tipo de Salón</label>
                    <select name="tipo_salon"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-100">
                        <option value="reuniones">Reuniones</option>
                        <option value="expos">Expos</option>
                        <option value="fiestas">Fiestas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 text-sm mb-1">Imagen</label>
                    <input type="file" name="imagen"
                        class="w-full text-gray-100 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btnCerrarModal"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-gray-200">Cancelar</button>
                <button type="submit"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div id="modalEliminar" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 shadow-2xl w-full max-w-md">
        <h2 class="text-xl text-white font-semibold mb-4">Confirmar eliminación</h2>
        <p class="text-gray-300 mb-6">¿Seguro que deseas eliminar este servicio?</p>
        <div class="flex justify-end space-x-3">
            <button id="cancelarEliminar"
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg">Cancelar</button>
            <button id="confirmarEliminar"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Eliminar</button>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("modalServicio");
    const modalEliminar = document.getElementById("modalEliminar");
    const modalTitle = document.getElementById("modalTitle");
    const form = document.getElementById("formServicio");
    const btnCerrar = document.getElementById("btnCerrarModal");
    let servicioAEliminar = null;

    function openModal(title) {
        modalTitle.textContent = title;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function closeModal() {
        modal.classList.add("hidden");
        form.reset();
        clearValidationErrors();
    }

    function openDeleteModal(id) {
        servicioAEliminar = id;
        modalEliminar.classList.remove("hidden");
        modalEliminar.classList.add("flex");
    }

    function closeDeleteModal() {
        modalEliminar.classList.add("hidden");
        servicioAEliminar = null;
    }

    function clearValidationErrors() {
        form.querySelectorAll(".error-message").forEach(el => el.remove());
        form.querySelectorAll(".border-red-500").forEach(input => input.classList.remove("border-red-500"));
    }

    function showValidationErrors(errors) {
        clearValidationErrors();
        for (const [field, msgs] of Object.entries(errors)) {
            const input = form.querySelector(`[name='${field}']`);
            if (input) {
                input.classList.add("border-red-500");
                const errorMsg = document.createElement("p");
                errorMsg.className = "error-message text-red-500 text-sm mt-1";
                errorMsg.textContent = msgs[0];
                input.insertAdjacentElement("afterend", errorMsg);
            }
        }
    }

    btnCerrar.addEventListener("click", closeModal);
    document.getElementById("cancelarEliminar").addEventListener("click", closeDeleteModal);

    // Nuevo Servicio
    document.getElementById("btnNuevoServicio").addEventListener("click", () => {
        form.reset();
        document.getElementById("servicioId").value = "";
        form.dataset.action = "/admin/servicios/nuevo/";
        openModal("Nuevo Servicio");
    });

    // Editar Servicio
    document.querySelectorAll(".btnEditar").forEach(btn => {
        btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const res = await fetch(`/admin/servicios/editar/${id}/`);
            const data = await res.json();
            const servicio = data.servicio;

            ["nombre", "precio", "tipo_salon"].forEach(k => {
                const input = form.querySelector(`[name='${k}']`);
                if (input) input.value = servicio[k] ?? "";
            });

            document.getElementById("servicioId").value = id;
            form.dataset.action = `/admin/servicios/editar/${id}/`;
            openModal("Editar Servicio");
        });
    });

    // Delegación de eventos para eliminar
document.addEventListener("click", async (e) => {
    // Abrir modal
    if (e.target.classList.contains("btnEliminar")) {
        servicioAEliminar = e.target.dataset.id;
        modalEliminar.classList.remove("hidden");
        modalEliminar.classList.add("flex");
    }

    // Confirmar eliminación
    if (e.target.id === "confirmarEliminar" && servicioAEliminar) {
        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
        const res = await fetch(`/admin/servicios/eliminar/${servicioAEliminar}/`, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
        });
        const result = await res.json();
        if (result.success) {
            // Elimina la fila directamente sin recargar
            const row = document.getElementById(`row-${servicioAEliminar}`);
            if (row) row.remove();
            servicioAEliminar = null;
            modalEliminar.classList.add("hidden");
        } else {
            alert("Error al eliminar el servicio.");
        }
    }

    // Cancelar eliminación
    if (e.target.id === "cancelarEliminar") {
        servicioAEliminar = null;
        modalEliminar.classList.add("hidden");
    }
});


    document.getElementById("confirmarEliminar").addEventListener("click", async () => {
        if (!servicioAEliminar) return;
        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
        const res = await fetch(`/admin/servicios/eliminar/${servicioAEliminar}/`, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
        });
        const result = await res.json();
        if (result.success) location.reload();
        else alert("Error al eliminar el servicio.");
        closeDeleteModal();
    });

    // Guardar / editar
    form.addEventListener("submit", async e => {
        e.preventDefault();
        clearValidationErrors();

        const res = await fetch(form.dataset.action, {
            method: "POST",
            body: new FormData(form)
        });

        const result = await res.json();

        if (result.success) {
            closeModal();
            location.reload();
        } else if (result.errors) {
            showValidationErrors(result.errors);
        } else {
            alert("Error desconocido al guardar el servicio.");
        }
    });
});
</script>
{% endblock %}
